name: Bump and Publish

# Only triggered by centralized release system or manual emergency release
# No longer triggers on PR merge to main
on:
  repository_dispatch:
    types: [trigger-release]
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      confirm_emergency:
        description: 'Type CONFIRM for emergency release'
        required: true
        type: string

jobs:

  validate:
    runs-on: ubuntu-latest
    outputs:
      bump_type: ${{ steps.validate.outputs.bump_type }}
    steps:
      - name: Validate trigger
        id: validate
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "âœ… Triggered by centralized release system"
            echo "bump_type=${{ github.event.client_payload.bump_type }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.confirm_emergency }}" != "CONFIRM" ]]; then
              echo "::error::Emergency release requires typing 'CONFIRM' in the confirmation field"
              exit 1
            fi
            echo "::warning::ðŸš¨ EMERGENCY RELEASE - triggered manually"
            echo "bump_type=${{ inputs.bump_type }}" >> $GITHUB_OUTPUT
          fi

  version-bump:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}

    steps:
    - name: Generate GitHub App Token
      id: generate-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ vars.NC_VERSION_BUMPER_APP_ID }}
        private-key: ${{ secrets.NC_VERSION_BUMPER_PRIVATE_KEY }}

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ steps.generate-token.outputs.token }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install bump2version

    - name: Bump version
      id: bump
      run: |
        BUMP_TYPE="${{ needs.validate.outputs.bump_type }}"
        
        echo "Bumping $BUMP_TYPE version"

        # Configure git
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        
        # Use bump2version to bump the version
        bump2version $BUMP_TYPE --allow-dirty
        NEW_VERSION=$(grep -m 1 '^current_version = ' .bumpversion.cfg | cut -d'=' -f2 | tr -d ' ')
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                
        git push origin main --tags

  publish-python:
    needs: version-bump
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Pull latest changes
      run: |
        git pull --tags
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install build tools
      run: |
        pip install --upgrade pip
        pip install build twine
    
    - name: Build Python package
      run: python -m build
    
    - name: Publish to PyPI
      env:
          TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      run: twine upload --skip-existing dist/*

  create-release:
    needs: [version-bump, publish-python]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Pull latest changes
      run: git pull --tags
    
    - name: Create GitHub Release
      uses: actions/github-script@v7
      with:
        script: |
          const version = '${{ needs.version-bump.outputs.new_version }}';
          
          await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: `v${version}`,
            name: `Release v${version}`,
            body: `## Release v${version}\n\n` +
                  `Published to:\n` +
                  `- PyPI: https://pypi.org/project/neuracore/${version}/\n` +
                  `### Installation\n` +
                  `\`\`\`bash\n` +
                  `pip install neuracore==${version}\n` +
                  `\`\`\``,
            draft: false,
            prerelease: false
          });
