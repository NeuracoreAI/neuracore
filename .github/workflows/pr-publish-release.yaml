name: PR Publish Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  check-if-release:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main' && github.event.pull_request.head.ref == 'develop'
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check_version.outputs.should_publish }}
      current_version: ${{ steps.extract_version.outputs.version }}
      pypi_version: ${{ steps.check_pypi.outputs.pypi_version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Pull latest changes
      run: git pull --tags

    - name: Extract version from .bumpversion.cfg
      id: extract_version
      run: |
        VERSION=$(grep '^current_version = ' .bumpversion.cfg | cut -d'=' -f2 | tr -d ' ')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Current version in repo: $VERSION"

    - name: Check PyPI for existing version
      id: check_pypi
      run: |
        # Query PyPI API for the latest version
        PYPI_VERSION=$(curl -s https://pypi.org/pypi/neuracore/json | jq -r '.info.version' || echo "none")
        echo "pypi_version=$PYPI_VERSION" >> $GITHUB_OUTPUT
        echo "Latest version on PyPI: $PYPI_VERSION"

    - name: Determine if we should publish
      id: check_version
      run: |
        CURRENT_VERSION="${{ steps.extract_version.outputs.version }}"
        PYPI_VERSION="${{ steps.check_pypi.outputs.pypi_version }}"

        echo "Comparing versions:"
        echo "  Current: $CURRENT_VERSION"
        echo "  PyPI:    $PYPI_VERSION"

        if [ "$CURRENT_VERSION" = "$PYPI_VERSION" ]; then
          echo "‚úó Versions match - no publish needed"
          echo "should_publish=false" >> $GITHUB_OUTPUT
        else
          echo "‚úì Version changed - will publish"
          echo "should_publish=true" >> $GITHUB_OUTPUT
        fi

  publish-python:
    needs: check-if-release
    if: needs.check-if-release.outputs.should_publish == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Pull latest changes
      run: git pull --tags

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        pip install --upgrade pip
        pip install build twine

    - name: Build Python package
      run: python -m build

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
        TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      run: twine upload --skip-existing dist/*

  create-release:
    needs: [check-if-release, publish-python]
    if: needs.check-if-release.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Pull latest changes
      run: git pull --tags

    - name: Read changelog
      id: read_changelog
      run: |
        VERSION="${{ needs.check-if-release.outputs.current_version }}"
        CHANGELOG_PATH="changelogs/${VERSION}-changelog.md"

        if [ ! -f "$CHANGELOG_PATH" ]; then
          echo "ERROR: Changelog not found at $CHANGELOG_PATH"
          exit 1
        fi

        # Read changelog content and escape for JSON
        CHANGELOG_CONTENT=$(cat "$CHANGELOG_PATH" | jq -Rs .)
        echo "changelog_content=$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT

        echo "Read changelog from: $CHANGELOG_PATH"

    - name: Create git tag
      run: |
        VERSION="${{ needs.check-if-release.outputs.current_version }}"
        TAG_NAME="v${VERSION}"

        # Configure git
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"

        # Check if tag already exists
        if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          echo "Tag $TAG_NAME already exists, skipping tag creation"
        else
          # Create and push tag
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "Created and pushed tag: $TAG_NAME"
        fi

    - name: Create GitHub Release
      uses: actions/github-script@v7
      env:
        CHANGELOG_BODY: ${{ steps.read_changelog.outputs.changelog_content }}
      with:
        script: |
          const version = '${{ needs.check-if-release.outputs.current_version }}';
          const changelogBody = JSON.parse(process.env.CHANGELOG_BODY);
          const tagName = `v${version}`;

          // Check if release already exists
          try {
            const existingRelease = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tagName
            });

            console.log(`Release ${tagName} already exists, skipping creation`);
            console.log(`Release URL: ${existingRelease.data.html_url}`);
            return;
          } catch (error) {
            if (error.status !== 404) {
              throw error;
            }
            // Release doesn't exist, continue to create it
          }

          const release = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: tagName,
            name: `Release v${version}`,
            body: changelogBody,
            draft: false,
            prerelease: false
          });

          console.log(`Created GitHub Release for v${version}`);
          console.log(`Release URL: ${release.data.html_url}`);

  final-summary:
    needs: [check-if-release, publish-python, create-release]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: Generate summary
      uses: actions/github-script@v7
      with:
        script: |
          const shouldPublish = '${{ needs.check-if-release.outputs.should_publish }}' === 'true';
          const currentVersion = '${{ needs.check-if-release.outputs.current_version }}';
          const pypiVersion = '${{ needs.check-if-release.outputs.pypi_version }}';

          const fs = require('fs');
          let summary = '';

          if (!shouldPublish) {
            summary += '# ‚ÑπÔ∏è No Publishing Needed\n\n';
            summary += `**Current version:** \`${currentVersion}\`\n`;
            summary += `**PyPI version:** \`${pypiVersion}\`\n\n`;
            summary += 'The version in the repository matches the version on PyPI.\n\n';
            summary += 'No publishing will occur.\n\n';
            summary += '---\n\n';
            summary += '**This can happen when:**\n';
            summary += '- Merging a manual PR that doesn\'t include a version bump\n';
            summary += '- Re-running the workflow after a successful publish\n';
            summary += '- Merging documentation or CI-only changes\n';
          } else {
            const publishSuccess = '${{ needs.publish-python.result }}' === 'success';
            const releaseSuccess = '${{ needs.create-release.result }}' === 'success';

            if (publishSuccess && releaseSuccess) {
              summary += '# ‚úÖ Release Published Successfully\n\n';
              summary += `**Version:** \`${currentVersion}\`\n`;
              summary += `**Previous PyPI version:** \`${pypiVersion}\`\n\n`;
              summary += '## Actions Completed\n\n';
              summary += '- ‚úÖ Package published to PyPI\n';
              summary += '- ‚úÖ Git tag created\n';
              summary += '- ‚úÖ GitHub Release created\n\n';
              summary += '### Links\n\n';
              summary += `- üì¶ [PyPI Package](https://pypi.org/project/neuracore/${currentVersion}/)\n`;
              summary += `- üè∑Ô∏è [GitHub Release](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/v${currentVersion})\n`;
              summary += `- üìù [Changelog](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/changelogs/${currentVersion}-changelog.md)\n\n`;
              summary += '### Installation\n\n';
              summary += '```bash\n';
              summary += `pip install neuracore==${currentVersion}\n`;
              summary += '```\n';
            } else {
              summary += '# ‚ùå Release Failed\n\n';
              summary += `**Version:** \`${currentVersion}\`\n\n`;
              summary += '## Status\n\n';
              summary += `- ${publishSuccess ? '‚úÖ' : '‚ùå'} Publish to PyPI\n`;
              summary += `- ${releaseSuccess ? '‚úÖ' : '‚ùå'} Create GitHub Release\n\n`;
              summary += 'Please check the workflow logs for error details.\n';
            }
          }

          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
